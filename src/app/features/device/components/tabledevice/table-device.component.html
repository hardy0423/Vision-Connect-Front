<div class="flex space-x-4 items-center justify-between mr-4 mb-3 ml-4">
  @if(isLoading) {
  <div></div>
  }@else {
  <div
    class="flex items-center space-x-1 p-3 rounded-md bg-blue-50 border border-blue-200 text-sm text-gray-800"
    [ngClass]="{
      invisible: deviceStatus !== 'active' || hideMessageInfo
    }"
  >
    <svg
      class="w-4 h-4 text-blue-500 mr-2"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M13 16h-1v-4h-1m1-4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"
      />
    </svg>

    <span class="text-gray-700">{{ "company.have" | translate }}</span>
    <span class="text-blue-600 font-semibold"> {{ totalUsed }} </span>
    <span class="text-gray-700">
      {{ "company.appareil" | translate }}{{ (totalUsed ?? 0) > 1 ? "s" : "" }}
    </span>
    <span class="text-gray-700">
      {{ "company.on" | translate
      }}{{ (companyDeviceLimit ?? 0) > 1 ? "s" : "" }}
    </span>
    <span class="text-green-600 font-semibold"> {{ companyDeviceLimit }} </span>
    <span class="text-gray-700">
      {{ "company.have_2" | translate
      }}{{ (companyDeviceLimit ?? 0) > 1 ? "s" : "" }}.
    </span>

    <!-- Custom close icon with hover effect -->
    <mat-icon
      (click)="hideMessage()"
      class="text-gray-500 ml-2 cursor-pointer hover:text-red-600"
    >
      close
    </mat-icon>
  </div>
  }

  <div class="flex items-center">
    <mat-radio-group
      [(ngModel)]="deviceStatus"
      (change)="applyDeviceStatusFilter()"
    >
      <mat-radio-button value="active" class="mr-4">
        {{ "device.device_actif" | translate }}
      </mat-radio-button>
      <mat-radio-button value="inactive">
        {{ "device.device_inactif" | translate }}
      </mat-radio-button>
    </mat-radio-group>
  </div>
</div>

<div class="w-full md:overflow-x-auto lg:overflow-visible">
  @if(isLoading) {
  <div class="flex justify-center p-4">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
  }@else {
  <table
    mat-table
    [dataSource]="dataSource"
    matSort
    class="mt-3 pt-4 table-auto w-full min-w-0"
  >
    <ng-container matColumnDef="type">
      <th mat-header-cell *matHeaderCellDef [style.maxWidth]="'150px'">
        <mat-form-field class="w-full">
          <mat-label>{{ "device.header_table.type" | translate }}</mat-label>
          <input
            matInput
            class="text-sm border-b-2 border-slate-500 focus:border-orange-400 w-full max-w-[180px]"
            (keyup)="applyFilter($event, 'type')"
          />
        </mat-form-field>
      </th>
      <td mat-cell *matCellDef="let device">
        {{ device.type.name }}
      </td>
    </ng-container>

    <!-- Status Column -->
    <ng-container matColumnDef="status">
      <th
        mat-header-cell
        *matHeaderCellDef
        class="p-3 bg-gray-100"
        [style.maxWidth]="'120px'"
      >
        <mat-form-field>
          <mat-label>{{ "device.header_table.status" | translate }}</mat-label>
          <mat-select
            (selectionChange)="applyDeviceFilterStatus($event)"
            class="text-sm"
            [style.width]="'100px'"
          >
            <mat-option
              *ngFor="let status of deviceOnAndOff"
              [value]="status"
              [style.maxWidth]="'90px'"
            >
              {{ status }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </th>
      <td mat-cell *matCellDef="let device">
        <div class="flex items-center justify-center">
          <ng-container
            *ngIf="
              device.uid === deviceDataStatus?.device_id &&
                deviceDataStatus?.position?.status;
              else defaultStatus
            "
          >
            <img
              [src]="
                deviceDataStatus?.position?.status === 'On'
                  ? 'assets/img/on.png'
                  : 'assets/img/off.png'
              "
              class="h-6 w-6 mr-2"
              [alt]="deviceDataStatus?.position?.status === 'On' ? 'On' : 'Off'"
            />
          </ng-container>
          <ng-template #defaultStatus>
            <img
              [src]="
                (device.mode_status || device.status) === 'On'
                  ? 'assets/img/on.png'
                  : 'assets/img/off.png'
              "
              class="h-6 w-6 mr-2"
              [alt]="
                (device.mode_status || device.status) === 'On' ? 'On' : 'Off'
              "
            />
          </ng-template>
        </div>
      </td>
    </ng-container>

    <!--Car Name Column -->
    <ng-container matColumnDef="car_name">
      <th mat-header-cell *matHeaderCellDef class="p-3 bg-gray-100">
        <mat-form-field class="w-full">
          <mat-label>{{
            "device.header_table.car_name" | translate
          }}</mat-label>
          <input
            matInput
            (keyup)="applyFilter($event, 'car_name')"
            class="text-sm w-full"
          />
        </mat-form-field>
      </th>
      <td mat-cell *matCellDef="let device" class="truncate">
        {{ device.car_name }}
      </td>

      <td mat-cell *matCellDef="let device">{{ device.car_name }}</td>
    </ng-container>

    <!-- Name Column -->
    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef class="p-3 bg-gray-100">
        <mat-form-field>
          <mat-label>{{ "device.header_table.name" | translate }}</mat-label>
          <input
            matInput
            (keyup)="applyFilter($event, 'name')"
            class="text-sm"
          />
        </mat-form-field>
      </th>
      <td mat-cell *matCellDef="let device">{{ device.name }}</td>
    </ng-container>

    <!-- IMEI Column -->
    <ng-container matColumnDef="imei">
      <th
        mat-header-cell
        *matHeaderCellDef
        class="p-3 bg-gray-100"
        [style.maxWidth]="'200px'"
      >
        <mat-form-field>
          <mat-label>{{ "device.header_table.imei" | translate }}</mat-label>
          <input matInput (keyup)="applyFilter($event, 'imei')" />
        </mat-form-field>
      </th>
      <td mat-cell *matCellDef="let device">{{ device.imei }}</td>
    </ng-container>

    <!-- SIM Number Column -->
    <ng-container matColumnDef="sim_number">
      <th mat-header-cell *matHeaderCellDef class="p-3 bg-gray-100">
        <mat-form-field>
          <mat-label>{{
            "device.header_table.sim_number" | translate
          }}</mat-label>
          <input matInput (keyup)="applyFilter($event, 'sim_number')" />
        </mat-form-field>
      </th>
      <td mat-cell *matCellDef="let device">{{ device.sim_number }}</td>
    </ng-container>

    <!-- Intervention Zone Column -->
    <ng-container matColumnDef="intervention_zone">
      <th mat-header-cell *matHeaderCellDef class="p-3 bg-gray-100">
        <mat-form-field>
          <mat-label>{{
            "device.header_table.intervention_zone" | translate
          }}</mat-label>
          <input matInput (keyup)="applyFilter($event, 'intervention_zone')" />
        </mat-form-field>
      </th>
      <td mat-cell *matCellDef="let device">
        {{ device.zone.nameZone }}
      </td>
    </ng-container>
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef class="w-24 text-center">
        <span class="flex justify-center">
          {{ "device.header_table.actions" | translate }}
        </span>
      </th>
      <td mat-cell *matCellDef="let device" class="w-24 text-center">
        @if(!device.is_actif) {
        <div class="flex justify-center space-x-2">
          <button
            mat-icon-button
            color="primary"
            (click)="restoreDevice(device)"
            matTooltip="{{ 'device.header_table.action_restore' | translate }}"
          >
            <mat-icon class="w-5 h-5">restore</mat-icon>
          </button>
        </div>
        }@else {
        <div class="flex justify-center space-x-1">
          <button
            mat-icon-button
            color="primary"
            (click)="openModal(false, device)"
            matTooltip="{{ 'device.header_table.action_update' | translate }}"
          >
            <mat-icon class="w-5 h-5">edit</mat-icon>
          </button>
          <button
            mat-icon-button
            color="accent"
            (click)="openDeleteModal(device)"
            matTooltip="{{ 'device.header_table.action_disable' | translate }}"
          >
            <mat-icon class="w-5 h-5">block</mat-icon>
          </button>
          <button
            mat-icon-button
            color="accent"
            (click)="openCommandModal(device)"
            matTooltip="{{ 'device.header_table.action_command' | translate }}"
            class="flex items-center justify-center p-1"
          >
            <img
              src="assets/img/control.png"
              alt="Commander"
              class="w-6 h-6 object-contain"
            />
          </button>
        </div>
        }
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: displayedColumns"
      (click)="selection.toggle(row)"
    ></tr>
  </table>
  }
</div>

<mat-paginator
  [length]="totalDevices"
  [pageSize]="pageSize"
  [pageSizeOptions]="[10, 25, 50]"
  (page)="onPageChange($event)"
  aria-label="Selection page"
>
</mat-paginator>
