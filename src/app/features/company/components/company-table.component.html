<div class="overflow-x-auto">
  <div class="flex items-center justify-between">
    <h1
      style="font-size: 20px"
      class="text-custom-gray ml-5"
      *ngIf="!idCompany"
    >
      {{ "company.company_list" | translate }}
    </h1>
    <div class=""></div>
    <button
      mat-raised-button
      color="accent"
      class="hover:primary/50"
      (click)="openModalUpdateNbrDevice()"
      *ngIf="isFmap && !idCompany"
    >
      {{ "company.update_nbr_device" | translate }}
    </button>
    <button
      mat-raised-button
      color="accent"
      (click)="openModal(true, companyInformation)"
      *ngIf="isVisionConnect && !idCompany"
    >
      {{ "company.add" | translate }}
    </button>
  </div>
  <div
    class="flex flex-row justify-between items-center ml-4 mr-4 mt-4"
    *ngIf="isAdminOrSuperUser && !idCompany && totalCount > 0"
  >
    <!-- Informations admin -->
    <div class="flex items-center space-x-2">
      <span class="text-gray-700">{{ "company.have" | translate }}</span>
      <span class="text-blue-500 font-bold">{{ totalNbrDevices }}</span>
      <span class="text-gray-700">
        {{ "company.appareil" | translate
        }}{{ (totalNbrDevices ?? 0) > 1 ? "s" : "" }}
      </span>
      <span class="text-gray-700"
        >{{ "company.on" | translate
        }}{{ (defaultCompanies?.nbr_device ?? 0) > 1 ? "s" : "" }}
      </span>

      <span class="text-redscale font-bold">{{
        defaultCompanies?.nbr_device
      }}</span>
      <span class="text-gray-700"
        >{{ "company.have_2" | translate
        }}{{ (defaultCompanies?.nbr_device ?? 0) > 1 ? "s" : "" }}.</span
      >
    </div>

    <!-- Filtres -->
    <div
      class="flex space-x-4 items-center justify-end"
      [ngClass]="{ 'absolute right-4': !userInformation?.is_admin }"
    >
      <mat-radio-group
        [(ngModel)]="companyStatus"
        (change)="applyCompanyStatusFilter()"
      >
        <mat-radio-button value="active" class="mr-4">
          <span class="text-black">{{ "company.actif" | translate }}</span>
        </mat-radio-button>
        <mat-radio-button value="inactive">
          <span class="text-black">{{ "company.inactif" | translate }}</span>
        </mat-radio-button>
      </mat-radio-group>
    </div>
  </div>

  <section
    class="company-container mt-5 z-0"
    tabindex="0"
    *ngIf="isAdminOrSuperUser && !idCompany"
  >
    <div class="w-full md:overflow-x-auto lg:overflow-visible">
      @if (isLoading) {
      <div class="flex justify-center p-4">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
      } @else if (totalCount == 0) {
      <p
        class="text-center text-lg font-semibold text-redscale p-4 bg-primary/10 border-l-4 border-redscale rounded-lg"
      >
        {{ "company.not_company" | translate }}
      </p>
      }@else {
      <table
        mat-table
        [dataSource]="dataSource"
        class="mt-3 pt-4 w-full table-auto"
      >
        <!-- Génération dynamique des colonnes -->
        <ng-container
          *ngFor="let column of displayedColumns"
          [matColumnDef]="column.name"
        >
          <th
            mat-header-cell
            *matHeaderCellDef
            class="p-3 text-left text-sm font-medium text-gray-700 bg-gray-100"
          >
            <mat-form-field class="w-full mt-1">
              <mat-label>{{ column.title }}</mat-label>
              <mat-icon matPrefix>search</mat-icon>
              <input
                matInput
                type="text"
                (keyup)="applyFilter($event, column.name)"
                placeholder="Rechercher..."
                class="text-sm"
              />
            </mat-form-field>
          </th>

          <td
            mat-cell
            *matCellDef="let element"
            class="p-3 text-sm text-gray-800"
          >
            <ng-container [ngSwitch]="column.name">
              <ng-container *ngSwitchCase="'is_actif'">
                {{ element.is_actif ? "Actif" : "Inactif" }}
              </ng-container>
              <ng-container *ngSwitchCase="'country'">
                {{ element.country?.name || "N/A" }}
              </ng-container>
              <ng-container *ngSwitchDefault>
                {{ element[column.name] }}
              </ng-container>
            </ng-container>
          </td>
        </ng-container>

        <!-- Colonne Action -->
        <ng-container matColumnDef="action">
          <th
            mat-header-cell
            *matHeaderCellDef
            class="p-3 text-center text-sm font-medium text-gray-700 bg-gray-100"
          >
            <span class="flex justify-center">
              {{ "user.column_titles.actions" | translate }}</span
            >
          </th>
          <td mat-cell *matCellDef="let element" class="p-3 text-center">
            <div class="flex justify-center space-x-2">
              <!-- Bouton Restore -->
              <button
                mat-icon-button
                matTooltip="Restaurer"
                color="primary"
                (click)="restoreCompany(element)"
                *ngIf="isAdminOrSuperUser && !element.is_actif"
                class="hover:bg-gray-100 rounded-full p-2"
              >
                <mat-icon class="w-5 h-5">restore</mat-icon>
              </button>

              <ng-container *ngIf="element.is_actif">
                <button
                  mat-icon-button
                  matTooltip="Modifier"
                  color="primary"
                  (click)="openModal(false, element)"
                  class="hover:bg-gray-100 rounded-full p-2"
                >
                  <mat-icon class="w-5 h-5">edit</mat-icon>
                </button>
                <button
                  mat-icon-button
                  matTooltip="Désactiver"
                  color="warn"
                  (click)="deleteCompany(element)"
                  *ngIf="isAdminOrSuperUser"
                  class="hover:bg-gray-100 rounded-full p-2"
                >
                  <mat-icon class="w-5 h-5">block</mat-icon>
                </button>
              </ng-container>
            </div>
          </td>
        </ng-container>
        <tr
          mat-header-row
          *matHeaderRowDef="columnNames"
          class="sticky top-0"
        ></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: columnNames"
          class="hover:bg-gray-50 transition-colors"
        ></tr>
      </table>
      }
    </div>
    <!-- Pagination -->
    <mat-paginator
      *ngIf="
        totalCount > 0 &&
        isAdminOrSuperUser &&
        (idCompany == null || idCompany == '')
      "
      [length]="totalCount"
      [pageSize]="limit"
      [pageSizeOptions]="[10, 25, 50, 100]"
      (page)="onPageChange($event)"
      aria-label="Pagination des entreprises"
    ></mat-paginator>
  </section>

  @if (isLoading) {
  <div class="flex justify-center p-4">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
  } @else {
  <div class="flex gap-6 items-start" *ngIf="idCompany">
    <div class="w-1/3 bg-white p-6 shadow-lg rounded-xl border border-gray-100">
      <div class="flex items-center justify-center relative">
        <img
          [src]="
            companyDetailView?.logo
              ? APIURL + companyDetailView?.logo
              : 'assets/svg/company.svg'
          "
          alt="Logo de {{ companyDetailView?.name }}"
          class="w-32 h-32 rounded-full object-cover border border-gray-300 shadow-sm"
        />
        <button (click)="openImageModal()" class="mt-24">
          <mat-icon class="text-gray-600">edit</mat-icon>
        </button>
      </div>

      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold text-primary truncate max-w-[80%]">
          {{ companyDetailView?.name }}
        </h1>
        <span
          class="px-2 py-1 text-xs font-semibold rounded-full"
          [ngClass]="
            companyDetailView?.is_actif
              ? 'bg-green-100 text-green-800'
              : 'bg-red-100 text-red-800'
          "
        >
          {{ companyDetailView?.is_actif ? "ACTIF" : "INACTIF" }}
        </span>
      </div>

      <div class="space-y-5">
        <div class="flex items-start">
          <mat-icon class="text-gray-400 mr-3 mt-0.5">email</mat-icon>
          <div>
            <p class="text-sm font-medium text-gray-500 mb-1">
              {{ "company.email" | translate }}
            </p>
            <a
              *ngIf="companyDetailView?.email"
              href="mailto:{{ companyDetailView?.email }}"
              class="text-primary hover:underline font-medium"
            >
              {{ companyDetailView?.email }}
            </a>
            <p *ngIf="!companyDetailView?.email" class="text-gray-500">
              Non spécifié
            </p>
          </div>
        </div>

        <div class="flex items-start">
          <mat-icon class="text-gray-400 mr-3 mt-0.5">devices</mat-icon>
          <div>
            <p class="text-sm font-medium text-gray-500 mb-1">
              {{ "company.devices" | translate }}
            </p>
            <p class="text-gray-800 font-medium">
              {{ companyDetailView?.nbr_device || "0" }}
              <span class="text-sm text-gray-500">{{
                "company.device" | translate
              }}</span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="w-2/3 bg-white p-6 shadow-lg rounded-xl border border-gray-100">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold text-primary">
          {{ "company.details" | translate }}
        </h3>
        <button
          mat-raised-button
          color="accent"
          (click)="openModal(false, companyDetailView!)"
        >
          {{ "company.update" | translate }}
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="flex items-start">
          <mat-icon class="text-gray-400 mr-3 mt-0.5">public</mat-icon>
          <div>
            <p class="text-sm font-medium text-gray-500 mb-1">
              {{ "company.country" | translate }}
            </p>
            <p class="text-gray-800 font-medium">
              {{ companyDetailView?.country?.name || "Non spécifié" }}
            </p>
          </div>
        </div>

        <div class="flex items-start">
          <mat-icon class="text-gray-400 mr-3 mt-0.5">location_on</mat-icon>
          <div>
            <p class="text-sm font-medium text-gray-500 mb-1">
              {{ "company.region" | translate }}
            </p>
            <p class="text-gray-800 font-medium">
              {{ companyDetailView?.region || "Non spécifié" }}
            </p>
          </div>
        </div>

        <div class="flex items-start">
          <mat-icon class="text-gray-400 mr-3 mt-0.5">home</mat-icon>
          <div>
            <p class="text-sm font-medium text-gray-500 mb-1">
              {{ "company.adress" | translate }}
            </p>
            <p class="text-gray-800 font-medium">
              {{ companyDetailView?.adress || "Non renseignée" }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  }
</div>
